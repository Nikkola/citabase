/*!
 * backbone.layoutmanager.js v0.7.5
 * Copyright 2012, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */

define(["backbone"],function(e){var t,e=window.Backbone,n=window._,r=window.$,i=e.View.prototype._configure,s=e.View.prototype.render,o=Array.prototype.push,u=Array.prototype.concat,a=Array.prototype.splice,f=e.View.extend({constructor:function(n){n=n||{},f.setupView(this,n),e.View.call(this,n)},insertView:function(e,t){return t?this.setView(e,t,!0):this.setView(e,!0)},insertViews:function(e){return n.isArray(e)?this.setViews({"":e}):(n.each(e,function(t,r){e[r]=n.isArray(t)?t:[t]}),this.setViews(e))},getView:function(e){return this.getViews(e).first().value()},getViews:function(e){var t=n.chain(this.views).map(function(e){return n.isArray(e)?e:[e]},this).flatten().value();return typeof e=="string"?n.chain([this.views[e]]).flatten():n.chain(typeof e=="function"?n.filter(t,e):t)},setView:function(e,t,r){var i,s,o,a=this;typeof e!="string"&&(r=t,t=e,e=""),this.views=this.views||{},i=t.__manager__,s=this.views[e];if(!i)throw new Error("Please set `View#manage` property with selector '"+e+"' to `true`.");return o=t._options(),i.parent=a,i.selector=e,r?(this.views[e]=u.call([],s||[],t),i.append=!0,t):(i.hasRendered&&o.partial(a.el,i.selector,t.el,i.append),s&&n.each(u.call([],s),function(e){e.remove()}),this.views[e]=t)},setViews:function(e){return n.each(e,function(e,t){if(n.isArray(e))return n.each(e,function(e){this.insertView(t,e)},this);this.setView(t,e)},this),this},render:function(){function a(){function a(){var n=t.afterRender;n&&n.call(e,e),e.trigger("afterRender",e)}var n,o;i&&(t.contains(i.el,e.el)||t.partial(i.el,r.selector,e.el,r.append)),e.delegateEvents(),r.hasRendered=!0,u.resolveWith(e,[e]),(n=r.queue.shift())?n():delete r.queue;if(s&&s.queue)return o=function(){i.off("afterRender",o,this),a()},i.on("afterRender",o,e);a()}function l(){var t=e._options(),r=e.__manager__,i=r.parent,s=i&&i.__manager__;e._render(f._viewRender,t).done(function(){if(!n.keys(e.views).length)return a();var r=n.map(e.views,function(e){var r=n.isArray(e);return r&&e.length?e[0].render().pipe(function(){return t.when(n.map(e.slice(1),function(e){return e.render()}))}):r?e:e.render()});t.when(r).done(function(){a()})})}var e=this,t=e._options(),r=e.__manager__,i=r.parent,s=i&&i.__manager__,u=t.deferred();return r.queue?o.call(r.queue,function(){l()}):(r.queue=[],l(e,u)),u.view=e,u},remove:function(){return f._removeView(this,!0),this._remove.apply(this,arguments)},_options:function(){return f.augment({},this,f.prototype.options,this.options)}},{_cache:{},_makeAsync:function(e,t){var n=e.deferred();return n.async=function(){return n._isAsync=!0,t},n},_viewRender:function(e,t){function u(n){n&&t.html(e.$el,n),s.resolveWith(e,[e])}function a(e,n){var i,s=f._makeAsync(t,function(e){u(e)});f.cache(r,n),n&&(i=t.render.call(s,n,e)),s._isAsync||u(i)}var r,i,s,o=e.__manager__;return{render:function(){var o=e.serialize||t.serialize,u=e.data||t.data,l=o||u,c=e.template||t.template;return n.isFunction(l)&&(l=l.call(e)),s=f._makeAsync(t,function(e){a(l,e)}),typeof c=="string"&&(r=t.prefix+c),(i=f.cache(r))?(a(l,i,r),s):(typeof c=="string"?i=t.fetch.call(s,t.prefix+c):c!=null&&(i=t.fetch.call(s,c)),s._isAsync||a(l,i),s)}}},_removeViews:function(e,t){typeof e=="boolean"&&(t=e,e=this),e=e||this,e.getViews().each(function(e){(e.__manager__.hasRendered||t)&&f._removeView(e,t)})},_removeView:function(e,t){var r,i=e.__manager__,s=typeof e.keep=="boolean"?e.keep:e.options.keep;if(!s&&(i.append===!0||t)){f.cleanViews(e),e._removeViews(!0),e.$el.remove();if(!i.parent)return;r=i.parent.views[i.selector];if(n.isArray(r))return n.each(n.clone(r),function(e,t){e&&e.__manager__===i&&a.call(r,t,1)});delete i.parent.views[i.selector]}},cleanViews:function(t){n.each(u.call([],t),function(t){t.unbind(),t.model instanceof e.Model&&t.model.off(null,null,t),t.collection instanceof e.Collection&&t.collection.off(null,null,t),t.cleanup&&t.cleanup.call(t)})},cache:function(e,t){if(e in this._cache)return this._cache[e];if(e!=null&&t!=null)return this._cache[e]=t},configure:function(t){this.augment(f.prototype.options,t),t.manage&&(e.View.prototype.manage=!0)},augment:n.forIn?function(e){return n.reduce(Array.prototype.slice.call(arguments,1),function(e,t){return n.forIn(t,function(t,n){e[n]=t}),e},e)}:n.extend,setupView:function(r,i){if(r.__manager__)return;var s,o,a,l=e.LayoutManager.prototype,c=n.pick(r,t);n.defaults(r,{views:{},__manager__:{},_removeViews:f._removeViews,_removeView:f._removeView},f.prototype),i=r.options=n.defaults(i||{},r.options,l.options),a=n.pick(i,u.call(["events"],n.values(i.events))),f.augment(r,a),(c.render===f.prototype.render||c.render===e.View.prototype.render)&&delete c.render,f.augment(i,c),r._remove=e.View.prototype.remove,r._render=function(e,t){var n=this,r=n.__manager__,i=t.beforeRender;return r.hasRendered&&this._removeViews(),i&&i.call(this,this),this.trigger("beforeRender",this),e(this,t).render()},r.render=f.prototype.render,r.remove!==l.remove&&(r._remove=r.remove,r.remove=l.remove),s=i.views||r.views,n.keys(s).length&&(o=s,r.views={},r.setViews(o)),r.options.template?r.options.template=i.template:r.template&&(i.template=r.template,delete r.template)}});e.Layout=e.LayoutView=e.LayoutManager=f,f.VERSION="0.7.5",e.View.prototype._configure=function(){var e=i.apply(this,arguments);return this.manage&&f.setupView(this),e},f.prototype.options={prefix:"",deferred:function(){return r.Deferred()},fetch:function(e){return n.template(r(e).html())},partial:function(e,t,n,i){var s=t?r(e).find(t):r(e);this[i?"append":"html"](s,n)},html:function(e,t){e.html(t)},append:function(e,t){e.append(t)},when:function(e){return r.when.apply(null,e)},render:function(e,t){return e(t)},contains:function(e,t){return r.contains(e,t)}},t=n.keys(f.prototype.options)});