/*
 * File:        ColumnFilterWidgets.js
 * Version:     1.0.2
 * Description: Controls for filtering based on unique column values in DataTables
 * Author:      Dylan Kuhn (www.cyberhobo.net)
 * Language:    Javascript
 * License:     GPL v2 or BSD 3 point style
 * Contact:     cyberhobo@cyberhobo.net
 * 
 * Copyright 2011 Dylan Kuhn (except fnGetColumnData by Benedikt Forchhammer), all rights reserved.
 *
 * This source file is free software, under either the GPL v2 license or a
 * BSD style license, available at:
 *   http://datatables.net/license_gpl2
 *   http://datatables.net/license_bsd
 */

(function(e){e.fn.dataTableExt.oApi.fnGetColumnData=function(e,t,n,r,i){if(typeof t=="undefined")return new Array;typeof n=="undefined"&&(n=!0),typeof r=="undefined"&&(r=!0),typeof i=="undefined"&&(i=!0);var s;r==1?s=e.aiDisplay:s=e.aiDisplayMaster;var o=new Array;for(var u=0,a=s.length;u<a;u++){iRow=s[u];var f=this.fnGetData(iRow),l=f[t];if(i==1&&l.length==0)continue;if(n==1&&jQuery.inArray(l,o)>-1)continue;o.push(l)}return o};var t=function(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")},n=function(t){var n=this,i="";return n.$WidgetContainer=e('<div class="column-filter-widgets"></div>'),n.$MenuContainer=n.$WidgetContainer,n.$TermContainer=null,n.aoWidgets=[],n.sSeparator="","oColumnFilterWidgets"in t.oInit&&("aiExclude"in t.oInit.oColumnFilterWidgets&&(i="|"+t.oInit.oColumnFilterWidgets.aiExclude.join("|")+"|"),"bGroupTerms"in t.oInit.oColumnFilterWidgets&&t.oInit.oColumnFilterWidgets.bGroupTerms&&(n.$MenuContainer=e('<div class="column-filter-widget-menus"></div>'),n.$TermContainer=e('<div class="column-filter-widget-selected-terms"></div>').hide())),e.each(t.aoColumns,function(s,o){var u=e('<div class="column-filter-widget"></div>');i.indexOf("|"+s+"|")<0&&(n.aoWidgets.push(new r(u,t,s,n)),n.$MenuContainer.append(u))}),n.$TermContainer&&(n.$WidgetContainer.append(n.$MenuContainer),n.$WidgetContainer.append(n.$TermContainer)),t.aoDrawCallback.push({name:"ColumnFilterWidgets",fn:function(){e.each(n.aoWidgets,function(e,t){t.fnDraw()})}}),n};n.prototype.getContainer=function(){return this.$WidgetContainer.get(0)};var r=function(t,n,r,i){var s=this,o;s.iColumn=r,s.oColumn=n.aoColumns[r],s.$Container=t,s.oDataTable=n.oInstance,s.asFilters=[],s.sSeparator="",s.bSort=!0,s.iMaxSelections=-1,"oColumnFilterWidgets"in n.oInit&&("sSeparator"in n.oInit.oColumnFilterWidgets&&(s.sSeparator=n.oInit.oColumnFilterWidgets.sSeparator),"iMaxSelections"in n.oInit.oColumnFilterWidgets&&(s.iMaxSelections=n.oInit.oColumnFilterWidgets.iMaxSelections),"aoColumnDefs"in n.oInit.oColumnFilterWidgets&&e.each(n.oInit.oColumnFilterWidgets.aoColumnDefs,function(t,n){var i="|"+n.aiTargets.join("|")+"|";i.indexOf("|"+r+"|")>=0&&e.each(n,function(e,t){s[e]=t})})),s.$Select=e("<select></select>").change(function(){var t=s.$Select.val(),n,r,o;if(""===t)return;n=e("<div>"+t+"</div>").text(),r=e('<a class="filter-term" href="#"></a>').addClass("filter-term-"+n.toLowerCase().replace(/\W/g,"")).text(n).click(function(){return s.asFilters=e.grep(s.asFilters,function(e){return e!=t}),r.remove(),i.$TermContainer&&0===i.$TermContainer.find(".filter-term").length&&i.$TermContainer.hide(),s.$Select.append(e("<option></option>").attr("value",t).text(n)),s.iMaxSelections>0&&s.iMaxSelections>s.asFilters.length&&s.$Select.attr("disabled",!1),s.fnFilter(),!1}),s.asFilters.push(t),i.$TermContainer?(i.$TermContainer.show(),i.$TermContainer.prepend(r)):s.$Select.after(r),o=s.$Select.children("option:selected"),s.$Select.val(""),o.remove(),s.iMaxSelections>0&&s.iMaxSelections<=s.asFilters.length&&s.$Select.attr("disabled",!0),s.fnFilter()}),s.$Container.append(s.$Select),s.fnDraw()};r.prototype.fnFilter=function(){var n=this,r=[],i,s;n.asFilters.length>0?(e.each(n.asFilters,function(e,n){r.push(t(n))}),i=n.sSeparator?"(^|"+n.sSeparator+")(":"^(",s=n.sSeparator?")("+n.sSeparator+"|$)":")$",n.oDataTable.fnFilter(i+r.join("|")+s,n.iColumn,!0,!1)):n.oDataTable.fnFilter("",n.iColumn)},r.prototype.fnDraw=function(){var t=this,n={},r=[],i;t.asFilters.length===0&&(i=t.oDataTable.fnGetColumnData(t.iColumn),e.each(i,function(i,s){var o=t.sSeparator?s.split(new RegExp(t.sSeparator)):[s];e.each(o,function(e,t){n.hasOwnProperty(t)||(n[t]=!0,r.push(t))})}),t.$Select.empty().append(e("<option></option>").attr("value","").text(t.oColumn.sTitle)),t.bSort&&(t.hasOwnProperty("fnSort")?r.sort(t.fnSort):r.sort()),e.each(r,function(n,r){var i;i=e("<div>"+r+"</div>").text(),t.$Select.append(e("<option></option>").attr("value",r).text(i))}),r.length>1?t.$Select.attr("disabled",!1):t.$Select.attr("disabled",!0))};if(typeof e.fn.dataTable!="function"||typeof e.fn.dataTableExt.fnVersionCheck!="function"||!e.fn.dataTableExt.fnVersionCheck("1.7.0"))throw"Warning: ColumnFilterWidgets requires DataTables 1.7 or greater - www.datatables.net/download";e.fn.dataTableExt.aoFeatures.push({fnInit:function(e){var t=new n(e);return t.getContainer()},cFeature:"W",sFeature:"ColumnFilterWidgets"})})(jQuery);