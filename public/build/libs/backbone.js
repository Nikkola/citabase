// (c) 2010-2012 Jeremy Ashkenas, DocumentCloud Inc.
// Backbone may be freely distributed under the MIT license.
// For all details and documentation:
// http://backbonejs.org

(function(e,t){typeof exports!="undefined"?t(e,exports,require("underscore")):typeof define=="function"&&define.amd?define(["underscore","jquery","exports"],function(n,r,i){e.Backbone=t(e,i,n,r)}):e.Backbone=t(e,{},e._,e.jQuery||e.Zepto||e.ender)})(this,function(e,t,n,r){var i=e.Backbone,s=[],o=s.push,u=s.slice,a=s.splice;t.VERSION="0.9.9",t.$=r,t.noConflict=function(){return e.Backbone=i,this},t.emulateHTTP=!1,t.emulateJSON=!1;var f=/\s+/,l=function(e,t,n,r){if(!n)return!0;if(typeof n=="object")for(var i in n)e[t].apply(e,[i,n[i]].concat(r));else{if(!f.test(n))return!0;n=n.split(f),i=0;for(var s=n.length;i<s;i++)e[t].apply(e,[n[i]].concat(r))}},c=function(e,t,n){var r,e=-1,i=t.length;switch(n.length){case 0:for(;++e<i;)(r=t[e]).callback.call(r.ctx);break;case 1:for(;++e<i;)(r=t[e]).callback.call(r.ctx,n[0]);break;case 2:for(;++e<i;)(r=t[e]).callback.call(r.ctx,n[0],n[1]);break;case 3:for(;++e<i;)(r=t[e]).callback.call(r.ctx,n[0],n[1],n[2]);break;default:for(;++e<i;)(r=t[e]).callback.apply(r.ctx,n)}},r=t.Events={on:function(e,t,n){return!l(this,"on",e,[t,n])||!t?this:(this._events||(this._events={}),(this._events[e]||(this._events[e]=[])).push({callback:t,context:n,ctx:n||this}),this)},once:function(e,t,r){if(!l(this,"once",e,[t,r])||!t)return this;var i=this,s=n.once(function(){i.off(e,s),t.apply(this,arguments)});return s._callback=t,this.on(e,s,r),this},off:function(e,t,r){var i,s,o,u,a,f,c,h;if(!this._events||!l(this,"off",e,[t,r]))return this;if(!e&&!t&&!r)return this._events={},this;u=e?[e]:n.keys(this._events);for(a=0,f=u.length;a<f;a++)if(e=u[a],i=this._events[e]){o=[];if(t||r)for(c=0,h=i.length;c<h;c++)s=i[c],(t&&t!==(s.callback._callback||s.callback)||r&&r!==s.context)&&o.push(s);this._events[e]=o}return this},trigger:function(e){if(!this._events)return this;var t=u.call(arguments,1);if(!l(this,"trigger",e,t))return this;var n=this._events[e],r=this._events.all;return n&&c(this,n,t),r&&c(this,r,arguments),this},listenTo:function(e,t,r){var i=this._listeners||(this._listeners={}),s=e._listenerId||(e._listenerId=n.uniqueId("l"));return i[s]=e,e.on(t,r||this,this),this},stopListening:function(e,t,n){var r=this._listeners;if(r){if(e)e.off(t,n,this),!t&&!n&&delete r[e._listenerId];else{for(var i in r)r[i].off(null,null,this);this._listeners={}}return this}}};r.bind=r.on,r.unbind=r.off,n.extend(t,r);var h=t.Model=function(e,t){var r,i=e||{};this.cid=n.uniqueId("c"),this.changed={},this.attributes={},this._changes=[],t&&t.collection&&(this.collection=t.collection),t&&t.parse&&(i=this.parse(i)),(r=n.result(this,"defaults"))&&n.defaults(i,r),this.set(i,{silent:!0}),this._currentAttributes=n.clone(this.attributes),this._previousAttributes=n.clone(this.attributes),this.initialize.apply(this,arguments)};n.extend(h.prototype,r,{changed:null,idAttribute:"id",initialize:function(){},toJSON:function(){return n.clone(this.attributes)},sync:function(){return t.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return n.escape(this.get(e))},has:function(e){return this.get(e)!=null},set:function(e,t,r){var i,s;if(e==null)return this;n.isObject(e)?(s=e,r=t):(s={})[e]=t;var e=r&&r.silent,o=r&&r.unset;if(!this._validate(s,r))return!1;this.idAttribute in s&&(this.id=s[this.idAttribute]);var u=this.attributes;for(i in s)t=s[i],o?delete u[i]:u[i]=t,this._changes.push(i,t);return this._hasComputed=!1,e||this.change(r),this},unset:function(e,t){return this.set(e,void 0,n.extend({},t,{unset:!0}))},clear:function(e){var t={},r;for(r in this.attributes)t[r]=void 0;return this.set(t,n.extend({},e,{unset:!0}))},fetch:function(e){e=e?n.clone(e):{},e.parse===void 0&&(e.parse=!0);var t=this,r=e.success;return e.success=function(n){if(!t.set(t.parse(n),e))return!1;r&&r(t,n,e)},this.sync("read",this,e)},save:function(e,t,r){var i,s,o;e==null||n.isObject(e)?(i=e,r=t):e!=null&&((i={})[e]=t),r=r?n.clone(r):{};if(r.wait){if(i&&!this._validate(i,r))return!1;s=n.clone(this.attributes)}e=n.extend({},r,{silent:!0});if(i&&!this.set(i,r.wait?e:r))return!1;if(!i&&!this._validate(null,r))return!1;var u=this,a=r.success;return r.success=function(e){o=!0;var t=u.parse(e);r.wait&&(t=n.extend(i||{},t));if(!u.set(t,r))return!1;a&&a(u,e,r)},t=this.isNew()?"create":r.patch?"patch":"update",t=="patch"&&(r.attrs=i),t=this.sync(t,this,r),!o&&r.wait&&(this.clear(e),this.set(s,e)),t},destroy:function(e){var e=e?n.clone(e):{},t=this,r=e.success,i=function(){t.trigger("destroy",t,t.collection,e)};e.success=function(n){(e.wait||t.isNew())&&i(),r&&r(t,n,e)};if(this.isNew())return e.success(),!1;var s=this.sync("delete",this,e);return e.wait||i(),s},url:function(){var e=n.result(this,"urlRoot")||n.result(this.collection,"url")||k();return this.isNew()?e:e+(e.charAt(e.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(e){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},change:function(e){var t=this._changing;this._changing=!0;var r=this._computeChanges(!0);this._pending=!!r.length;for(var i=r.length-2;i>=0;i-=2)this.trigger("change:"+r[i],this,r[i+1],e);if(t)return this;for(;this._pending;)this._pending=!1,this.trigger("change",this,e),this._previousAttributes=n.clone(this.attributes);return this._changing=!1,this},hasChanged:function(e){return this._hasComputed||this._computeChanges(),e==null?!n.isEmpty(this.changed):n.has(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?n.clone(this.changed):!1;var t,r=!1,i=this._previousAttributes,s;for(s in e)n.isEqual(i[s],t=e[s])||((r||(r={}))[s]=t);return r},_computeChanges:function(e){this.changed={};for(var t={},n=[],r=this._currentAttributes,i=this._changes,s=i.length-2;s>=0;s-=2){var o=i[s],u=i[s+1];t[o]||(t[o]=!0,r[o]!==u&&(this.changed[o]=u,e&&(n.push(o,u),r[o]=u)))}return e&&(this._changes=[]),this._hasComputed=!0,n},previous:function(e){return e==null||!this._previousAttributes?null:this._previousAttributes[e]},previousAttributes:function(){return n.clone(this._previousAttributes)},_validate:function(e,t){if(!this.validate)return!0;var e=n.extend({},this.attributes,e),r=this.validate(e,t);return r?(t&&t.error&&t.error(this,r,t),this.trigger("error",this,r,t),!1):!0}});var p=t.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),t.comparator!==void 0&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,n.extend({silent:!0},t))};n.extend(p.prototype,r,{model:h,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return t.sync.apply(this,arguments)},add:function(e,t){var r,i,s,u,f=t&&t.at,l=(t&&t.sort)==null?!0:t.sort,e=n.isArray(e)?e.slice():[e];for(r=e.length-1;r>=0;r--)(i=this._prepareModel(e[r],t))?(e[r]=i,(s=i.id!=null&&this._byId[i.id])||this._byCid[i.cid]?(t&&t.merge&&s&&(s.set(i.attributes,t),u=l),e.splice(r,1)):(i.on("all",this._onModelEvent,this),this._byCid[i.cid]=i,i.id!=null&&(this._byId[i.id]=i))):(this.trigger("error",this,e[r],t),e.splice(r,1));e.length&&(u=l),this.length+=e.length,r=[f!=null?f:this.models.length,0],o.apply(r,e),a.apply(this.models,r),u&&this.comparator&&f==null&&this.sort({silent:!0});if(t&&t.silent)return this;for(;i=e.shift();)i.trigger("add",i,this,t);return this},remove:function(e,t){var r,i,s,o;t||(t={}),e=n.isArray(e)?e.slice():[e];for(r=0,i=e.length;r<i;r++)if(o=this.get(e[r]))delete this._byId[o.id],delete this._byCid[o.cid],s=this.indexOf(o),this.models.splice(s,1),this.length--,t.silent||(t.index=s,o.trigger("remove",o,this,t)),this._removeReference(o);return this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,n.extend({at:this.length},t)),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,n.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},slice:function(e,t){return this.models.slice(e,t)},get:function(e){return e==null?void 0:this._byId[e.id!=null?e.id:e]||this._byCid[e.cid||e]},at:function(e){return this.models[e]},where:function(e){return n.isEmpty(e)?[]:this.filter(function(t){for(var n in e)if(e[n]!==t.get(n))return!1;return!0})},sort:function(e){if(!this.comparator)throw Error("Cannot sort a set without a comparator");return n.isString(this.comparator)||this.comparator.length===1?this.models=this.sortBy(this.comparator,this):this.models.sort(n.bind(this.comparator,this)),(!e||!e.silent)&&this.trigger("sort",this,e),this},pluck:function(e){return n.invoke(this.models,"get",e)},update:function(e,t){var r,i,s,o,u=[],a=[],f={},l=this.model.prototype.idAttribute,t=n.extend({add:!0,merge:!0,remove:!0},t);t.parse&&(e=this.parse(e)),n.isArray(e)||(e=e?[e]:[]);if(t.add&&!t.remove)return this.add(e,t);for(i=0,s=e.length;i<s;i++)r=e[i],o=this.get(r.id||r.cid||r[l]),t.remove&&o&&(f[o.cid]=!0),(t.add&&!o||t.merge&&o)&&u.push(r);if(t.remove)for(i=0,s=this.models.length;i<s;i++)r=this.models[i],f[r.cid]||a.push(r);return a.length&&this.remove(a,t),u.length&&this.add(u,t),this},reset:function(e,t){t||(t={}),t.parse&&(e=this.parse(e));for(var r=0,i=this.models.length;r<i;r++)this._removeReference(this.models[r]);return t.previousModels=this.models,this._reset(),e&&this.add(e,n.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},fetch:function(e){e=e?n.clone(e):{},e.parse===void 0&&(e.parse=!0);var t=this,r=e.success;return e.success=function(n){t[e.update?"update":"reset"](n,e),r&&r(t,n,e)},this.sync("read",this,e)},create:function(e,t){var r=this,t=t?n.clone(t):{},e=this._prepareModel(e,t);if(!e)return!1;t.wait||r.add(e,t);var i=t.success;return t.success=function(e,t,n){n.wait&&r.add(e,n),i&&i(e,t,n)},e.save(null,t),e},parse:function(e){return e},clone:function(){return new this.constructor(this.models)},chain:function(){return n(this.models).chain()},_reset:function(){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(e,t){if(e instanceof h)return e.collection||(e.collection=this),e;t||(t={}),t.collection=this;var n=new this.model(e,t);return n._validate(e,t)?n:!1},_removeReference:function(e){this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,r){(e==="add"||e==="remove")&&n!==this||(e==="destroy"&&this.remove(t,r),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],t.id!=null&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments))}}),n.each("forEach,each,map,collect,reduce,foldl,inject,reduceRight,foldr,find,detect,filter,select,reject,every,all,some,any,include,contains,invoke,max,min,sortedIndex,toArray,size,first,head,take,initial,rest,tail,last,without,indexOf,shuffle,lastIndexOf,isEmpty".split(","),function(e){p.prototype[e]=function(){var t=u.call(arguments);return t.unshift(this.models),n[e].apply(n,t)}}),n.each(["groupBy","countBy","sortBy"],function(e){p.prototype[e]=function(t,r){var i=n.isFunction(t)?t:function(e){return e.get(t)};return n[e](this.models,i,r)}});var s=t.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},d=/\((.*?)\)/g,v=/:\w+/g,m=/\*\w+/g,g=/[\-{}\[\]+?.,\\\^$|#\s]/g;n.extend(s.prototype,r,{initialize:function(){},route:function(e,r,i){return n.isRegExp(e)||(e=this._routeToRegExp(e)),i||(i=this[r]),t.history.route(e,n.bind(function(n){n=this._extractParameters(e,n),i&&i.apply(this,n),this.trigger.apply(this,["route:"+r].concat(n)),t.history.trigger("route",this,r,n)},this)),this},navigate:function(e,n){return t.history.navigate(e,n),this},_bindRoutes:function(){if(this.routes)for(var e,t=n.keys(this.routes);(e=t.pop())!=null;)this.route(e,this.routes[e])},_routeToRegExp:function(e){return e=e.replace(g,"\\$&").replace(d,"(?:$1)?").replace(v,"([^/]+)").replace(m,"(.*?)"),RegExp("^"+e+"$")},_extractParameters:function(e,t){return e.exec(t).slice(1)}});var y=t.History=function(){this.handlers=[],n.bindAll(this,"checkUrl"),typeof window!="undefined"&&(this.location=window.location,this.history=window.history)},b=/^[#\/]|\s+$/g,w=/^\/+|\/+$/g,E=/msie [\w.]+/,S=/\/$/;y.started=!1,n.extend(y.prototype,r,{interval:50,getHash:function(e){return(e=(e||this).location.href.match(/#(.*)$/))?e[1]:""},getFragment:function(e,t){if(e==null)if(this._hasPushState||!this._wantsHashChange||t){var e=this.location.pathname,n=this.root.replace(S,"");e.indexOf(n)||(e=e.substr(n.length))}else e=this.getHash();return e.replace(b,"")},start:function(e){if(y.started)throw Error("Backbone.history has already been started");y.started=!0,this.options=n.extend({},{root:"/"},this.options,e),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!(!this.options.pushState||!this.history||!this.history.pushState);var e=this.getFragment(),r=document.documentMode,r=E.exec(navigator.userAgent.toLowerCase())&&(!r||r<=7);this.root=("/"+this.root+"/").replace(w,"/"),r&&this._wantsHashChange&&(this.iframe=t.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e)),this._hasPushState?t.$(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!r?t.$(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=e,e=this.location,r=e.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!r)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&r&&e.hash&&(this.fragment=this.getHash().replace(b,""),this.history.replaceState({},document.title,this.root+this.fragment+e.search));if(!this.options.silent)return this.loadUrl()},stop:function(){t.$(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),y.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(){var e=this.getFragment();e===this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe)));if(e===this.fragment)return!1;this.iframe&&this.navigate(e),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(e){var t=this.fragment=this.getFragment(e);return n.any(this.handlers,function(e){if(e.route.test(t))return e.callback(t),!0})},navigate:function(e,t){if(!y.started)return!1;if(!t||t===!0)t={trigger:t};e=this.getFragment(e||"");if(this.fragment!==e){this.fragment=e;var n=this.root+e;if(this._hasPushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,e,t.replace))}t.trigger&&this.loadUrl(e)}},_updateHash:function(e,t,n){n?(n=e.href.replace(/(javascript:|#).*$/,""),e.replace(n+"#"+t)):e.hash="#"+t}}),t.history=new y;var x=t.View=function(e){this.cid=n.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},T=/^(\S+)\s*(.*)$/,N="model,collection,el,id,attributes,className,tagName,events".split(",");n.extend(x.prototype,r,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},make:function(e,n,r){return e=document.createElement(e),n&&t.$(e).attr(n),r!=null&&t.$(e).html(r),e},setElement:function(e,n){return this.$el&&this.undelegateEvents(),this.$el=e instanceof t.$?e:t.$(e),this.el=this.$el[0],n!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(e||(e=n.result(this,"events"))){this.undelegateEvents();for(var t in e){var r=e[t];n.isFunction(r)||(r=this[e[t]]);if(!r)throw Error('Method "'+e[t]+'" does not exist');var i=t.match(T),s=i[1],i=i[2],r=n.bind(r,this);s+=".delegateEvents"+this.cid,i===""?this.$el.bind(s,r):this.$el.delegate(i,s,r)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(e){this.options&&(e=n.extend({},n.result(this,"options"),e)),n.extend(this,n.pick(e,N)),this.options=e},_ensureElement:function(){if(this.el)this.setElement(n.result(this,"el"),!1);else{var e=n.extend({},n.result(this,"attributes"));this.id&&(e.id=n.result(this,"id")),this.className&&(e["class"]=n.result(this,"className")),this.setElement(this.make(n.result(this,"tagName"),e),!1)}}});var C={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};t.sync=function(e,r,i){var s=C[e];n.defaults(i||(i={}),{emulateHTTP:t.emulateHTTP,emulateJSON:t.emulateJSON});var o={type:s,dataType:"json"};i.url||(o.url=n.result(r,"url")||k()),i.data==null&&r&&(e==="create"||e==="update"||e==="patch")&&(o.contentType="application/json",o.data=JSON.stringify(i.attrs||r.toJSON(i))),i.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{model:o.data}:{});if(i.emulateHTTP&&(s==="PUT"||s==="DELETE"||s==="PATCH")){o.type="POST",i.emulateJSON&&(o.data._method=s);var u=i.beforeSend;i.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",s);if(u)return u.apply(this,arguments)}}o.type!=="GET"&&!i.emulateJSON&&(o.processData=!1);var a=i.success;i.success=function(e,t,n){a&&a(e,t,n),r.trigger("sync",r,e,i)};var f=i.error;return i.error=function(e){f&&f(r,e,i),r.trigger("error",r,e,i)},e=t.ajax(n.extend(o,i)),r.trigger("request",r,e,i),e},t.ajax=function(){return t.$.ajax.apply(t.$,arguments)},h.extend=p.extend=s.extend=x.extend=y.extend=function(e,t){var r=this,i;i=e&&n.has(e,"constructor")?e.constructor:function(){r.apply(this,arguments)},n.extend(i,r,t);var s=function(){this.constructor=i};return s.prototype=r.prototype,i.prototype=new s,e&&n.extend(i.prototype,e),i.__super__=r.prototype,i};var k=function(){throw Error('A "url" property or function must be specified')};return t});